<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universe Sandbox 3 - 統計</title>
    <!-- Roboto Font Load -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Default is dark theme */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a202c; /* Dark mode background color */
            color: #e2e8f0;
            box-sizing: border-box; /* Ensures padding and borders are included in the width */
            overflow-x: hidden; /* Prevents horizontal scrolling */
        }
        .container {
            max-width: 1200px;
        }
        .card {
            background-color: #2d3748; /* Dark mode card background color */
        }
        input[type="date"], input[type="password"] {
            background-color: #4a5568;
            border-color: #4a5568;
        }
        /* Light theme */
        @media (prefers-color-scheme: light) {
            body {
                background-color: #f7fafc; /* Light mode background color */
                color: #1a202c; /* Text color in light mode matches dark mode background */
            }
            .card {
                background-color: #ffffff; /* Light mode card background color */
            }
            input[type="date"], input[type="password"] {
                background-color: #edf2f7;
                border-color: #e2e8f0;
                color: #1a202c; /* Text color in light mode matches dark mode background */
            }
            .light-mode-text-black {
                color: #1a202c; /* A specific class for this color */
            }
            .table-header {
                background-color: #e2e8f0;
                color: #1a202c;
            }
            .table-row-odd {
                background-color: #f7fafc;
            }
            /* Counter text color for light mode */
            .counter-text {
                color: #1a202c;
            }
        }
        /* For dark theme */
        @media (prefers-color-scheme: dark) {
            body {
                color: #f7fafc; /* Text color in dark mode matches light mode background */
            }
            .table-header {
                background-color: #4a5568;
                color: #f7fafc;
            }
            .table-row-odd {
                background-color: #2d3748;
            }
            /* Counter text color for dark mode */
            .counter-text {
                color: #ffffff;
            }
        }
        
        /* Adjust ApexCharts tooltip style */
        .apexcharts-tooltip {
            font-family: 'Roboto', sans-serif !important;
        }

        .active-btn {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
        }

        .inactive-btn {
            background-color: #4a5568; /* bg-gray-600 */
            color: white;
        }
        
        .inactive-btn:hover {
            background-color: #6b7280; /* hover:bg-gray-700 */
        }

        /* Table specific styles */
        .data-table-container {
            max-height: 500px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container w-full mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">
                Universe Sandbox 3 - 統計
            </h1>
            <p class="text-gray-400 mt-2">この統計はシミュレーションに基づく架空のデータであり、実際のものではありません。</p>
        </header>

        <!-- Counters section -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="card p-6 rounded-xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                <div class="flex items-center text-xl font-bold text-blue-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-people mr-2" viewBox="0 0 16 16">
                        <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1zm-7.978-1L7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002-.014.002zM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4m3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0M6.936 9.28a6 6 0 0 0-1.23-.247A7 7 0 0 0 5 9c-4 0-5 3-5 4q0 1 1 1h4.216A2.24 2.24 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816M4.92 10A5.5 5.5 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275ZM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0m3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4"/>
                    </svg>
                    <span>CCU</span>
                </div>
                <p id="ccu-counter" class="text-4xl font-extrabold mt-2 counter-text">0</p>
            </div>
            <div class="card p-6 rounded-xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                <div class="flex items-center text-xl font-bold text-green-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-hand-thumbs-up mr-2" viewBox="0 0 16 16">
                        <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2 2 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a10 10 0 0 0-.443.05 9.4 9.4 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a9 9 0 0 1 1.036-.157c.663-.06 1.457-.054 2.211.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.2 2.2 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.9.9 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
                    </svg>
                    <span>合計高評価数</span>
                </div>
                <p id="positive-counter" class="text-4xl font-extrabold mt-2 counter-text">0</p>
            </div>
            <div class="card p-6 rounded-xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                <div class="flex items-center text-xl font-bold text-red-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-hand-thumbs-down mr-2" viewBox="0 0 16 16">
                        <path d="M8.864 15.674c-.956.24-1.843-.484-1.908-1.42-.072-1.05-.23-2.015-.428-2.59-.125-.36-.479-1.012-1.04-1.638-.557-.624-1.282-1.179-2.131-1.41C2.685 8.432 2 7.85 2 7V3c0-.845.682-1.464 1.448-1.546 1.07-.113 1.564-.415 2.068-.723l.048-.029c.272-.166.578-.349.97-.484C6.931.08 7.395 0 8 0h3.5c.937 0 1.599.478 1.934 1.064.164.287.254.607.254.913 0 .152-.023.312-.077-.464.201.262.38.577.488.9.11.33.172.762.004 1.15.069.13.12.268.159.403.077.27.113.567.113.856s-.036.586-.113.856c-.035.12-.08.244-.138.363.394.571.418 1.2.234 1.733-.206.592-.682 1.1-1.2 1.272-.847.283-1.803.276-2.516.211a10 10 0 0 1-.443-.05 9.36 9.36 0 0 1-.062 4.51c-.138.508-.55.848-1.012.964zM11.5 1H8c-.51 0-.863.068-1.14.163-.281.097-.506.229-.776.393l-.04.025c-.555.338-1.198.73-2.49.868-.333.035-.554.29-.554.55V7c0 .255.226.543.62.65 1.095.3 1.977.997 2.614 1.709.635.71 1.064 1.475 1.238 1.977.243.7.407 1.768.482 2.85.025.362.36.595.667.518l.262-.065c.16-.04.258-.144.288-.255a8.34 8.34 0 0 0-.145-4.726.5.5 0 0 1 .595-.643h.003l.014.004.058.013a9 9 0 0 0 1.036.157c.663.06 1.457.054 2.11-.163.175-.059.45-.301.57-.651.107-.308.087-.67-.266-1.021L12.793 7l.353-.354c.043-.042.105-.14.154-.315.048-.167.075-.37.075-.581s-.027-.414-.075-.581c-.05-.174-.111-.273-.154-.315l-.353-.354.353-.354c.047-.047.109-.176.005-.488a2.2 2.2 0 0 0-.505-.804l-.353-.354.353-.354c.006-.005.041-.05.041-.17a.9.9 0 0 0-.121-.415C12.4 1.272 12.063 1 11.5 1"/>
                    </svg>
                    <span>合計低評価数</span>
                </div>
                <p id="negative-counter" class="text-4xl font-extrabold mt-2 counter-text">0</p>
            </div>
            <div class="card p-6 rounded-xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                 <div class="flex items-center text-xl font-bold text-yellow-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-percent mr-2" viewBox="0 0 16 16">
                        <path d="M13.442 2.558a.625.625 0 0 1 0 .884l-10 10a.625.625 0 1 1-.884-.884l10-10a.625.625 0 0 1 .884 0M4.5 6a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m0 1a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5m7 6a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m0 1a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5"/>
                    </svg>
                    <span>高評価率</span>
                </div>
                <p id="positive-ratio-counter" class="text-4xl font-extrabold mt-2 counter-text">0%</p>
            </div>
            <div class="card p-6 rounded-xl shadow-lg transform transition-transform duration-300 hover:scale-105">
                <div class="flex items-center text-xl font-bold text-indigo-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-trophy mr-2" viewBox="0 0 16 16">
                        <path d="M2.5.5A.5.5 0 0 1 3 0h10a.5.5 0 0 1 .5.5q0 .807-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 0 1-.3.9H3a.5.5 0 0 1-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33 33 0 0 1 2.5.5m.099 2.54a2 2 0 0 0 .72 3.935c-.333-1.05-.588-2.346-.72-3.935m10.083 3.935a2 2 0 0 0 .72-3.935c-.133 1.59-.388 2.885-.72 3.935M3.504 1q.01.775.056 1.469c.13 2.028.457 3.546.87 4.667C5.294 9.48 6.484 10 7 10a.5.5 0 0 1 .5.5v2.61a1 1 0 0 1-.757.97l-1.426.356a.5.5 0 0 0-.179.085L4.5 15h7l-.638-.479a.5.5 0 0 0-.18-.085l-1.425-.356a1 1 0 0 1-.757-.97V10.5A.5.5 0 0 1 9 10c.516 0 1.706-.52 2.57-2.864.413-1.12.74-2.64.87-4.667q.045-.694.056-1.469z"/>
                    </svg>
                    <span>期間内ピークCCU</span>
                </div>
                <p id="peak-ccu-counter" class="text-4xl font-extrabold mt-2 counter-text">0</p>
            </div>
        </div>

        <!-- Chart section -->
        <div class="card p-6 rounded-xl shadow-lg">
            <div class="flex flex-col space-y-4 mb-4">
                <!-- Granularity buttons -->
                <div class="flex flex-wrap gap-2 items-center">
                    <p class="text-gray-300 light-mode-text-black">表示粒度:</p>
                    <button id="btn-30m" data-granularity="30m" class="px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">30分</button>
                    <button id="btn-1h" data-granularity="1h" class="px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">1時間</button>
                    <button id="btn-1d" data-granularity="1d" class="px-4 py-2 active-btn font-bold rounded-lg transition-colors">1日</button>
                </div>

                <!-- Period buttons -->
                <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                    <div id="date-range-buttons" class="flex flex-wrap gap-2">
                        <button data-days="1" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">1日</button>
                        <button data-days="3" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">3日</button>
                        <button data-days="7" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">7日</button>
                        <button data-days="14" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">14日</button>
                        <button data-days="28" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">28日</button>
                        <button data-days="56" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">56日</button>
                        <button data-days="90" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">90日</button>
                        <button data-days="180" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">180日</button>
                        <button data-days="360" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">360日</button>
                        <button data-days="all" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">全期間</button>
                        <button data-days="custom" class="date-btn px-4 py-2 inactive-btn font-bold rounded-lg transition-colors">カスタム</button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex flex-col items-start md:items-center md:flex-row md:space-x-2">
                            <div class="flex items-center space-x-2">
                                <label for="start-date-picker" class="text-gray-300 light-mode-text-black whitespace-nowrap">開始日:</label>
                                <input type="date" id="start-date-picker" class="bg-gray-700 border border-gray-600 text-white p-2 rounded-lg" disabled>
                            </div>
                            <div class="flex items-center space-x-2 mt-2 md:mt-0">
                                <label for="end-date-picker" class="text-gray-300 light-mode-text-black whitespace-nowrap">終了日:</label>
                                <input type="date" id="end-date-picker" class="bg-gray-700 border border-gray-600 text-white p-2 rounded-lg" disabled>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="text-right mt-2">
                    <span id="date-range-info" class="text-xs text-gray-400"></span>
                </div>
            </div>
            <div id="chart-container" class="mt-4">
                <div id="apex-chart"></div>
            </div>
        </div>
        
        <!-- Data Table Section -->
        <div class="card p-6 rounded-xl shadow-lg mt-8">
            <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-4">
                データ詳細
            </h2>
            <div class="data-table-container rounded-lg border border-gray-600">
                <table class="w-full text-left table-auto">
                    <thead class="sticky top-0 z-10">
                        <tr class="table-header">
                            <th class="p-3 font-semibold text-sm rounded-tl-lg">日付</th>
                            <th class="p-3 font-semibold text-sm">CCU</th>
                            <th class="p-3 font-semibold text-sm">CCU (%)</th>
                            <th class="p-3 font-semibold text-sm">合計高評価数</th>
                            <th class="p-3 font-semibold text-sm">高評価数 (%)</th>
                            <th class="p-3 font-semibold text-sm">合計低評価数</th>
                            <th class="p-3 font-semibold text-sm">低評価数 (%)</th>
                            <th class="p-3 font-semibold text-sm">高評価率</th>
                            <th class="p-3 font-semibold text-sm">高評価率 (%)</th>
                            <th class="p-3 font-semibold text-sm">期間内ピークCCU</th>
                            <th class="p-3 font-semibold text-sm rounded-tr-lg">ピークCCU (%)</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- Data rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Gemini Insights Section -->
        <div class="card p-6 rounded-xl shadow-lg mt-8">
            <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-teal-500 mb-4">
                Gemini Insights
            </h2>
            <!-- API Key Input -->
            <div class="mb-4">
                <label for="api-key-input" class="block text-gray-300 light-mode-text-black mb-2">Gemini APIキー (クライアントサイドで処理されるため、自己責任でご利用ください):</label>
                <input type="password" id="api-key-input" placeholder="ここにAPIキーを入力してください" class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 text-white">
            </div>
            <button id="generate-insights-btn" class="flex items-center justify-center px-6 py-3 bg-gradient-to-r from-green-500 to-teal-600 text-white font-bold rounded-xl shadow-lg hover:from-green-600 hover:to-teal-700 transform transition-transform duration-300 hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars mr-2" viewBox="0 0 16 16">
                  <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/>
                </svg>
                <span>統計分析とマーケティング戦略を生成</span>
            </button>
            <div id="insights-output" class="mt-4 p-4 bg-gray-700 rounded-lg whitespace-pre-wrap text-sm text-gray-200 hidden">
                <!-- Insights will be displayed here -->
            </div>
            <div id="loading-spinner" class="mt-4 hidden">
                <div class="flex items-center justify-center space-x-2">
                    <div class="w-4 h-4 rounded-full bg-blue-500 animate-pulse"></div>
                    <div class="w-4 h-4 rounded-full bg-blue-500 animate-pulse delay-75"></div>
                    <div class="w-4 h-4 rounded-full bg-blue-500 animate-pulse delay-150"></div>
                    <span class="text-gray-400">分析を生成中...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ApexCharts JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script>
        // Define app ID for Firestore usage
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // JavaScript code to generate data and draw the chart
        document.addEventListener('DOMContentLoaded', () => {

            // Array to store all data points
            let fullDailyData = [];
            // Current chart object
            let chart;
            // Current granularity of the timestamps
            let currentGranularity = '1d';
            // Latest filtered and interpolated data
            let currentProcessedData = [];


            // Define the start and end dates of the dataset
            const datasetStartDate = new Date('2025-12-31T00:00:00Z');
            const datasetEndDate = new Date('2030-01-01T00:00:00Z');

            /**
             * Generates realistic data.
             * @param {Date} startDate - Start date of the data.
             * @param {Date} endDate - End date of the data.
             * @returns {Array<Object>} - An array of generated data.
             */
            function generateDailyData(startDate, endDate) {
                const data = [];
                let currentTime = new Date(startDate);
                
                let cumulativePositive = 0;
                let cumulativeNegative = 0;

                // User-specified CCU data points
                const ccuPoints = [
                    { date: new Date('2026-01-01'), ccu: 10000 },
                    { date: new Date('2027-01-01'), ccu: 35000000 },
                    { date: new Date('2028-01-01'), ccu: 30000000 },
                    { date: new Date('2029-01-01'), ccu: 22500000 },
                    { date: new Date('2030-01-01'), ccu: 19250000 }
                ];
                
                // Determine CCU fluctuations for the entire period
                const ccuTimeline = {};
                for (let i = 0; i < ccuPoints.length - 1; i++) {
                    const startPoint = ccuPoints[i];
                    const endPoint = ccuPoints[i + 1];

                    let currentDate = new Date(startPoint.date);
                    const totalDays = (endPoint.date.getTime() - startPoint.date.getTime()) / (1000 * 60 * 60 * 24);

                    let dayCount = 0;
                    while (currentDate < endPoint.date) {
                        const progress = dayCount / totalDays;
                        let baseCcu;
                        
                        const startYear = startPoint.date.getFullYear();
                        if (startYear === 2026) {
                            baseCcu = startPoint.ccu + (endPoint.ccu - startPoint.ccu) * (1 - Math.exp(-progress * 5));
                        } else if (startYear === 2027) {
                            baseCcu = endPoint.ccu + (startPoint.ccu - endPoint.ccu) * (1 / (1 + Math.exp(10 * progress - 5)));
                        } else if (startYear === 2028) {
                            baseCcu = startPoint.ccu + (endPoint.ccu - startPoint.ccu) * Math.sin(progress * Math.PI / 2);
                        } else if (startYear === 2029) {
                            baseCcu = startPoint.ccu + (endPoint.ccu - startPoint.ccu) * progress;
                        }

                        const noise = (Math.random() - 0.5) * 0.1 * baseCcu;
                        ccuTimeline[currentDate.toISOString().slice(0, 10)] = Math.max(10000, Math.floor(baseCcu + noise));
                        
                        currentDate.setDate(currentDate.getDate() + 1);
                        dayCount++;
                    }
                }

                while (currentTime <= endDate) {
                    const dateString = currentTime.toISOString().slice(0, 10);
                    let baseCcu = ccuTimeline[dateString] || 10000;
                    
                    // Simulate weekend boost
                    const dayOfWeek = currentTime.getDay(); // 0: Sunday, 6: Saturday
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        baseCcu *= 1.4; // 40% boost on weekends
                    }
                    
                    // Simulate monthly updates
                    const isUpdateDay = currentTime.getDate() === 1 && currentTime.getMonth() !== startDate.getMonth();

                    // Boost ratings on update days
                    let positiveRatingsBoost = 0;
                    let negativeRatingsBoost = 0;
                    if (isUpdateDay) {
                        positiveRatingsBoost = 200000;
                        negativeRatingsBoost = 15000;
                    }

                    // Create CCU data point
                    const ccuPoint = createCcuDataPoint(currentTime, baseCcu, isUpdateDay);

                    // Create rating data point (linked to CCU)
                    const ratingPoint = createRatingDataPoint(currentTime, ccuPoint.ccu, positiveRatingsBoost, negativeRatingsBoost);
                    
                    // 評価数を累積
                    cumulativePositive += ratingPoint.positive;
                    cumulativeNegative += ratingPoint.negative;
                    
                    // 累積評価数に基づいて高評価率を計算
                    const cumulativeTotalRatings = cumulativePositive + cumulativeNegative;
                    const cumulativePositiveRatio = cumulativeTotalRatings > 0 ? (cumulativePositive / cumulativeTotalRatings) * 100 : 0;

                    data.push({
                        ...ccuPoint,
                        ...ratingPoint,
                        cumulativePositive: cumulativePositive,
                        cumulativeNegative: cumulativeNegative,
                        ratio: parseFloat(cumulativePositiveRatio.toFixed(2)) // 計算した累積高評価率を格納
                    });

                    currentTime.setDate(currentTime.getDate() + 1);
                }
                return data;
            }

            /**
             * Helper function to create a CCU data point.
             * @param {Date} date - The timestamp.
             * @param {number} ccu - The concurrent user count.
             * @param {boolean} isUpdateDay - Whether it's an update day.
             * @returns {Object} - The CCU data.
             */
            function createCcuDataPoint(date, ccu, isUpdateDay) {
                let actualCcu = ccu;

                // On update days, simulate a sharp increase
                if (isUpdateDay) {
                    const updatePeak = ccu * 2; // Double on update
                    actualCcu = updatePeak;
                }

                return {
                    timestamp: date.getTime(),
                    ccu: Math.floor(actualCcu),
                };
            }

            /**
             * Helper function to create a rating data point.
             * @param {Date} date - The timestamp.
             * @param {number} ccu - The CCU for the day.
             * @param {number} positiveRatingsBoost - Boost in positive ratings for updates.
             * @param {number} negativeRatingsBoost - Boost in negative ratings for updates.
             * @returns {Object} - The ratings data.
             */
            function createRatingDataPoint(date, ccu, positiveRatingsBoost, negativeRatingsBoost) {
                const dailyPositiveBase = ccu * (0.001 + Math.random() * 0.001); // 0.1% to 0.2%
                const dailyNegativeBase = ccu * (0.0001 + Math.random() * 0.0001); // 0.01% to 0.02%
                
                const positiveRatings = Math.floor(dailyPositiveBase) + positiveRatingsBoost;
                const negativeRatings = Math.floor(dailyNegativeBase) + negativeRatingsBoost;
                
                // ★★★ 変更点: 高評価率の計算を削除し、日ごとの評価数のみを返す ★★★
                return {
                    positive: positiveRatings,
                    negative: negativeRatings
                };
            }

            /**
             * Filters data based on the selected date range.
             * @param {Array<Object>} allData - All data.
             * @param {Date} startDate - Start date.
             * @param {Date} endDate - End date.
             * @returns {Array<Object>} - The filtered data.
             */
            function filterDataByDateRange(allData, startDate, endDate) {
                const startTimestamp = startDate.getTime();
                const endTimestamp = endDate.getTime();
                return allData.filter(d => d.timestamp >= startTimestamp && d.timestamp <= endTimestamp);
            }

            /**
             * Interpolates data based on granularity (with diurnal cycles).
             * @param {Array<Object>} dailyData - Data in daily intervals.
             * @param {string} granularity - '30m', '1h', or '1d'.
             * @returns {Array<Object>} - The interpolated data.
             */
            function interpolateData(dailyData, granularity) {
                let peakSoFar = 0;
                const dataWithPeak = dailyData.map(d => {
                    if (d.ccu > peakSoFar) peakSoFar = d.ccu;
                    return {...d, peakCcu: peakSoFar};
                });
                
                if (granularity === '1d' || dataWithPeak.length <= 1) {
                    return dataWithPeak;
                }

                const interpolated = [];
                const interval = granularity === '30m' ? 30 * 60 * 1000 : 60 * 60 * 1000;
                const dailyCycle = 24 * 60 * 60 * 1000;
                
                let currentPeak = 0;

                for (let i = 0; i < dataWithPeak.length - 1; i++) {
                    const d1 = dataWithPeak[i];
                    const d2 = dataWithPeak[i + 1];
                    
                    if (d1.ccu > currentPeak) {
                        currentPeak = d1.ccu;
                    }

                    interpolated.push({ ...d1, peakCcu: currentPeak });

                    let currentTimestamp = d1.timestamp + interval;
                    while (currentTimestamp < d2.timestamp) {
                        const dayProgress = ((currentTimestamp - d1.timestamp) % dailyCycle) / dailyCycle;
                        
                        const diurnalFactor = 0.5 * Math.sin(dayProgress * 2 * Math.PI - Math.PI / 2) + 0.5;
                        
                        const ratio = (currentTimestamp - d1.timestamp) / (d2.timestamp - d1.timestamp);
                        const linearCcu = d1.ccu + (d2.ccu - d1.ccu) * ratio;
                        
                        const randomNoise = (Math.random() - 0.5) * 0.1;
                        
                        const ccuValue = Math.floor(linearCcu * (0.8 + diurnalFactor * 0.2) + linearCcu * randomNoise);
                        
                        if (ccuValue > currentPeak) {
                            currentPeak = ccuValue;
                        }

                        // ★★★ 変更点: 補間された累積評価数から高評価率を再計算 ★★★
                        const interpolatedCumulativePositive = Math.floor(d1.cumulativePositive + (d2.cumulativePositive - d1.cumulativePositive) * ratio);
                        const interpolatedCumulativeNegative = Math.floor(d1.cumulativeNegative + (d2.cumulativeNegative - d1.cumulativeNegative) * ratio);
                        const interpolatedTotalRatings = interpolatedCumulativePositive + interpolatedCumulativeNegative;
                        const interpolatedRatio = interpolatedTotalRatings > 0 ? (interpolatedCumulativePositive / interpolatedTotalRatings) * 100 : 0;

                        const newPoint = {
                            timestamp: currentTimestamp,
                            ccu: ccuValue,
                            positive: Math.floor(d1.positive + (d2.positive - d1.positive) * ratio),
                            negative: Math.floor(d1.negative + (d2.negative - d1.negative) * ratio),
                            ratio: parseFloat(interpolatedRatio.toFixed(2)), // 再計算した高評価率を使用
                            cumulativePositive: interpolatedCumulativePositive,
                            cumulativeNegative: interpolatedCumulativeNegative,
                            peakCcu: currentPeak
                        };
                        interpolated.push(newPoint);
                        currentTimestamp += interval;
                    }
                }
                
                const lastDataPoint = dataWithPeak[dataWithPeak.length - 1];
                if (lastDataPoint && lastDataPoint.ccu > currentPeak) {
                    currentPeak = lastDataPoint.ccu;
                }
                if(lastDataPoint) {
                    interpolated.push({ ...lastDataPoint, peakCcu: currentPeak });
                }
                
                return interpolated;
            }

            /**
             * Calculates the percentage change between consecutive data points for each metric.
             * @param {Array<Object>} data - The data to calculate changes for.
             * @returns {Array<Object>} - The data with added percentage change properties.
             */
            function calculatePercentageChange(data) {
                const initialNulls = { ccuChange: null, positiveChange: null, negativeChange: null, ratioChange: null, peakCcuChange: null };
                if (data.length <= 1) {
                    return data.map(d => ({ ...d, ...initialNulls }));
                }
                
                return data.map((d, index) => {
                    if (index === 0) {
                        return { ...d, ...initialNulls };
                    }
                    
                    const prevD = data[index - 1];
                    const ccuChange = prevD.ccu === 0 ? null : ((d.ccu - prevD.ccu) / prevD.ccu) * 100;
                    const positiveChange = prevD.cumulativePositive === 0 ? null : ((d.cumulativePositive - prevD.cumulativePositive) / prevD.cumulativePositive) * 100;
                    const negativeChange = prevD.cumulativeNegative === 0 ? null : ((d.cumulativeNegative - prevD.cumulativeNegative) / prevD.cumulativeNegative) * 100;
                    const ratioChange = prevD.ratio === 0 ? null : ((d.ratio - prevD.ratio) / prevD.ratio) * 100;
                    const peakCcuChange = prevD.peakCcu === 0 ? null : ((d.peakCcu - prevD.peakCcu) / prevD.peakCcu) * 100;

                    return { ...d, ccuChange, positiveChange, negativeChange, ratioChange, peakCcuChange };
                });
            }


            /**
             * Renders or updates the chart.
             * @param {Array<Object>} data - The data to plot.
             */
            function renderChart(data) {
                if (!data || data.length === 0) {
                    if (chart) chart.destroy();
                    chart = null;
                    document.querySelector("#apex-chart").innerHTML = "";
                    return;
                }
                
                const seriesColors = ['#008FFB', '#00E396', '#FF4560', '#FEB019', '#775DD0'];

                const ccuSeries = data.map(d => [d.timestamp, d.ccu]);
                const positiveSeries = data.map(d => [d.timestamp, d.cumulativePositive]);
                const negativeSeries = data.map(d => [d.timestamp, d.cumulativeNegative]);
                const ratioSeries = data.map(d => [d.timestamp, d.ratio]);
                const periodPeakCcuSeries = data.map(d => [d.timestamp, d.peakCcu]);

                const isLightMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
                
                // ★★★ 修正箇所 ★★★
                // ダークモードの時は 'dark' テーマを、ライトモードの時は 'light' テーマをツールチップに適用します。
                const tooltipTheme = isLightMode ? 'light' : 'dark';

                const options = {
                    series: [
                        { name: 'CCU', data: ccuSeries },
                        { name: '合計高評価数', data: positiveSeries },
                        { name: '合計低評価数', data: negativeSeries },
                        { name: '高評価率', data: ratioSeries },
                        { name: '期間内ピークCCU', data: periodPeakCcuSeries }
                    ],
                    chart: {
                        id: 'universe-sandbox-chart',
                        type: 'line',
                        height: 400,
                        toolbar: { show: true, autoSelected: 'zoom' },
                        background: isLightMode ? '#ffffff' : '#2d3748',
                        fontFamily: 'Roboto, sans-serif'
                    },
                    colors: seriesColors,
                    stroke: { curve: 'smooth', width: [2, 2, 2, 2, 1.5] },
                    xaxis: {
                        type: 'datetime',
                        labels: {
                           datetimeUTC: false,
                           format: currentGranularity === '1d' ? 'yy/MM/dd' : 'MM/dd HH:mm',
                           style: { colors: isLightMode ? '#333' : '#fff' }
                        },
                        tooltip: { enabled: true }
                    },
                    yaxis: [
                        { // Y-axis 1: CCU (Left)
                            seriesName: 'CCU',
                            axisTicks: { show: true },
                            axisBorder: { show: true, color: seriesColors[0] },
                            labels: {
                                style: { colors: seriesColors[0] },
                                formatter: val => val !== undefined ? Math.round(val).toLocaleString() : '0'
                            },
                            title: { text: 'CCU', style: { color: seriesColors[0] } },
                        },
                        { // Y-axis 2: Positive Ratings (Right)
                            seriesName: '合計高評価数',
                            opposite: true,
                            axisTicks: { show: true },
                            axisBorder: { show: true, color: seriesColors[1] },
                            labels: {
                                style: { colors: seriesColors[1] },
                                formatter: val => val !== undefined ? Math.round(val).toLocaleString() : '0'
                            },
                            title: { text: '合計高評価数', style: { color: seriesColors[1] } },
                        },
                        { // Y-axis 3: Negative Ratings (Right)
                            seriesName: '合計低評価数',
                            opposite: true,
                            axisTicks: { show: true },
                            axisBorder: { show: true, color: seriesColors[2] },
                            labels: {
                                style: { colors: seriesColors[2] },
                                formatter: val => val !== undefined ? Math.round(val).toLocaleString() : '0'
                            },
                            title: { text: '合計低評価数', style: { color: seriesColors[2] } },
                        },
                        { // Y-axis 4: Ratio (Right)
                            seriesName: '高評価率',
                            opposite: true,
                            min: 0,
                            max: 100,
                            axisTicks: { show: true },
                            axisBorder: { show: true, color: seriesColors[3] },
                            labels: {
                                style: { colors: seriesColors[3] },
                                formatter: val => `${val ? val.toFixed(1) : '0'}%`
                            },
                            title: { text: '高評価率 (%)', style: { color: seriesColors[3] } },
                        },
                        { // Y-axis 5: Peak CCU (Right)
                            seriesName: '期間内ピークCCU',
                            opposite: true,
                            axisTicks: { show: true },
                            axisBorder: { show: true, color: seriesColors[4] },
                            labels: {
                                style: { colors: seriesColors[4] },
                                formatter: val => val !== undefined ? Math.round(val).toLocaleString() : '0'
                            },
                            title: { text: '期間内ピークCCU', style: { color: seriesColors[4] } },
                        }
                    ],
                    tooltip: {
                        x: { format: 'yyyy/MM/dd HH:mm' },
                        y: {
                            formatter: (val, opts) => {
                                const dataIndex = opts.dataPointIndex;
                                const seriesIndex = opts.seriesIndex;
                                const dataPoint = data[dataIndex];
                                
                                let formattedValue = (val !== null && val !== undefined) ? Math.round(val).toLocaleString() : 'N/A';
                                let changeText = '';
                                
                                if (dataPoint) {
                                    let change = null;
                                    switch(seriesIndex) {
                                        case 0: change = dataPoint.ccuChange; break;
                                        case 1: change = dataPoint.positiveChange; break;
                                        case 2: change = dataPoint.negativeChange; break;
                                        case 3: 
                                            change = dataPoint.ratioChange;
                                            formattedValue = `${val ? val.toFixed(2) : '0.00'}%`;
                                            break;
                                        case 4: change = dataPoint.peakCcuChange; break;
                                    }

                                    if (change !== null && change !== undefined) {
                                        const arrow = change >= 0 ? '▲' : '▼';
                                        const color = change >= 0 ? 'text-green-400' : 'text-red-400';
                                        changeText = `<span class="${color} ml-2">${arrow} ${Math.abs(change).toFixed(2)}%</span>`;
                                    }
                                }
                               
                                return `${formattedValue} ${changeText}`;
                            }
                        },
                        theme: tooltipTheme, // 修正したテーマを適用
                        shared: true,
                        intersect: false
                    },
                    dataLabels: { enabled: false },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'left',
                        labels: { colors: isLightMode ? '#333' : '#fff' }
                    },
                    grid: { borderColor: isLightMode ? '#e2e8f0' : '#4a5568' }
                };

                if (chart) {
                    chart.updateOptions(options);
                } else {
                    chart = new ApexCharts(document.querySelector("#apex-chart"), options);
                    chart.render();
                }
            }

            /**
             * Renders the data in a table.
             * @param {Array<Object>} data - The data to display in the table.
             */
            function renderTable(data) {
                const tableBody = document.getElementById('data-table-body');
                tableBody.innerHTML = ''; // Clear existing rows

                if (!data || data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="11" class="p-3 text-center text-gray-500">表示するデータがありません。</td>`;
                    tableBody.appendChild(row);
                    return;
                }

                const reversedData = [...data].reverse();

                reversedData.forEach((d, index) => {
                    const row = document.createElement('tr');
                    row.classList.add('transition-colors', 'duration-200');
                    if (index % 2 === 1) {
                        row.classList.add('table-row-odd');
                    } else {
                        row.classList.add('hover:bg-gray-700', 'light:hover:bg-gray-100');
                    }
                    
                    const date = new Date(d.timestamp);
                    let dateString;
                    if (currentGranularity === '1d') {
                        dateString = date.toLocaleDateString();
                    } else {
                        dateString = date.toLocaleString();
                    }

                    const formatChange = (change) => {
                        if (change === null || change === undefined) return '-';
                        const colorClass = change >= 0 ? 'text-green-400' : 'text-red-400';
                        const arrow = change >= 0 ? '▲' : '▼';
                        return `<span class="${colorClass}">${arrow} ${Math.abs(change).toFixed(2)}%</span>`;
                    };

                    row.innerHTML = `
                        <td class="p-3 text-sm">${dateString}</td>
                        <td class="p-3 text-sm">${d.ccu.toLocaleString()}</td>
                        <td class="p-3 text-sm">${formatChange(d.ccuChange)}</td>
                        <td class="p-3 text-sm">${d.cumulativePositive.toLocaleString()}</td>
                        <td class="p-3 text-sm">${formatChange(d.positiveChange)}</td>
                        <td class="p-3 text-sm">${d.cumulativeNegative.toLocaleString()}</td>
                        <td class="p-3 text-sm">${formatChange(d.negativeChange)}</td>
                        <td class="p-3 text-sm">${d.ratio.toFixed(2)}%</td>
                        <td class="p-3 text-sm">${formatChange(d.ratioChange)}</td>
                        <td class="p-3 text-sm">${d.peakCcu.toLocaleString()}</td>
                        <td class="p-3 text-sm">${formatChange(d.peakCcuChange)}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            /**
             * Updates the counter values.
             * @param {Array<Object>} data - The data to use for counters.
             */
            function updateCounters(data) {
                if (!data || data.length === 0) {
                    document.getElementById('ccu-counter').textContent = '0';
                    document.getElementById('positive-counter').textContent = '0';
                    document.getElementById('negative-counter').textContent = '0';
                    document.getElementById('positive-ratio-counter').textContent = '0%';
                    document.getElementById('peak-ccu-counter').textContent = '0';
                    return;
                }

                const latestData = data[data.length - 1];
                document.getElementById('ccu-counter').textContent = latestData.ccu.toLocaleString();
                document.getElementById('positive-counter').textContent = latestData.cumulativePositive.toLocaleString();
                document.getElementById('negative-counter').textContent = latestData.cumulativeNegative.toLocaleString();
                document.getElementById('positive-ratio-counter').textContent = `${latestData.ratio.toFixed(2)}%`;
                
                const peakCcuInView = data.reduce((max, current) => Math.max(max, current.ccu), 0);
                document.getElementById('peak-ccu-counter').textContent = peakCcuInView.toLocaleString();
            }

            /**
             * Main function to update the chart and counters.
             */
            function updateUI() {
                const startDatePicker = document.getElementById('start-date-picker');
                const endDatePicker = document.getElementById('end-date-picker');

                let startDate = new Date(startDatePicker.value);
                let endDate = new Date(endDatePicker.value);
                
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    return;
                }
                
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(23, 59, 59, 999);

                const filteredData = filterDataByDateRange(fullDailyData, startDate, endDate);
                currentProcessedData = interpolateData(filteredData, currentGranularity);
                currentProcessedData = calculatePercentageChange(currentProcessedData);
                
                renderChart(currentProcessedData);
                renderTable(currentProcessedData);
                updateCounters(currentProcessedData);
            }

            /**
             * Updates the style of the active button.
             * @param {Element} buttonContainer - The container element holding the buttons.
             * @param {string} activeId - The ID of the button to make active.
             */
            function updateActiveButton(buttonContainer, activeId) {
                const buttons = buttonContainer.querySelectorAll('button');
                buttons.forEach(btn => {
                    if (btn.id === activeId || btn.dataset.days === activeId) {
                        btn.classList.add('active-btn');
                        btn.classList.remove('inactive-btn');
                    } else {
                        btn.classList.add('inactive-btn');
                        btn.classList.remove('active-btn');
                    }
                });
            }

            /**
             * Calls the Gemini API to generate insights about the game statistics.
             */
            async function generateInsights() {
                const insightsOutput = document.getElementById('insights-output');
                const loadingSpinner = document.getElementById('loading-spinner');
                const apiKeyInput = document.getElementById('api-key-input');
                const apiKey = apiKeyInput.value;
                const startDatePicker = document.getElementById('start-date-picker');
                const endDatePicker = document.getElementById('end-date-picker');

                insightsOutput.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');

                if (!apiKey) {
                    insightsOutput.textContent = 'APIキーを入力してください。';
                    insightsOutput.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    return;
                }
                
                localStorage.setItem('gemini-api-key', apiKey);

                const startDate = new Date(startDatePicker.value);
                const endDate = new Date(endDatePicker.value);
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    insightsOutput.textContent = '有効な日付範囲を選択してください。';
                    insightsOutput.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    return;
                }

                const insightsData = filterDataByDateRange(fullDailyData, startDate, endDate);
                if (insightsData.length === 0) {
                    insightsOutput.textContent = '分析するデータがありません。期間を選択してください。';
                    insightsOutput.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                    return;
                }
                
                const dataString = insightsData.map(d => 
                    `Date: ${new Date(d.timestamp).toLocaleDateString()}, CCU: ${d.ccu}, Cumulative Positive: ${d.cumulativePositive}, Cumulative Negative: ${d.cumulativeNegative}, Positive Ratio: ${d.ratio}%`
                ).join('\n');

                // Corrected typos and structured the prompt
                const prompt = `
**ゲーム概要:**
Universe Sandbox 3は、2025年12月31日にリリースされた、価格0円のGiant Armyが開発・販売している宇宙シミュレーションゲームです。
このゲームの最大の特徴は、宇宙空間の物理法則をリアルタイムでシミュレーションできることにあります。重力、衝突、気候、物質の相互作用などをリアルに再現しており、プレイヤーは宇宙を自由に創造したり、破壊したりすることができます。
具体的には、以下のようなことができます。
- **天体の創造と操作:** 惑星、恒星、ブラックホールなどを自由に配置し、その軌道や質量などを変更できます。
- **壮大な衝突シミュレーション:** 惑星と惑星、恒星と恒星を衝突させ、その結果を観察できます。
- **気候変動のシミュレーション:** 地球の傾きや太陽からの距離を変え、気候がどう変化するかをモデル化できます。
- **架空の宇宙空間の作成:** 実際に存在しない独自の太陽系や銀河系を作り出すことができます。
このように、『Universe Sandbox 3』は、宇宙の壮大なスケールと、物理法則の美しさ、そして天体の儚さを体験できる、シミュレーションと教育の要素を兼ね備えたゲームとなっています。

---

**分析依頼:**
以下のデータは、この架空のゲーム「Universe Sandbox 3」の${startDate.toLocaleDateString()}から${endDate.toLocaleDateString()}までの統計です。このゲームの背景情報を踏まえ、データに基づいてゲームのパフォーマンスについての簡潔な分析と、CCUトレンドを考慮したマーケティング戦略の提案を日本語でMarkdown形式で提供してください。

**統計データ:**
${dataString}

---

**出力形式:**
分析結果と提案は、以下のセクションに分けてください。
### ゲームパフォーマンス分析
### マーケティング戦略提案
`;

                try {
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    // ★★★★★ ユーザーの要求に応じてモデル名を絶対に変更 ★★★★★
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error.message}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        insightsOutput.innerHTML = marked.parse(text); 
                    } else {
                         throw new Error('APIからの応答が予期した形式ではありません。応答内容を確認してください。');
                    }
                    
                } catch (error) {
                    console.error('Failed to generate insights:', error);
                    insightsOutput.textContent = `分析の生成に失敗しました: ${error.message}`;
                } finally {
                    loadingSpinner.classList.add('hidden');
                    insightsOutput.classList.remove('hidden');
                }
            }

            // Set up event listeners
            const granularityButtons = document.querySelectorAll('[data-granularity]');
            granularityButtons.forEach(button => {
                button.addEventListener('click', () => {
                    currentGranularity = button.dataset.granularity;
                    updateActiveButton(document.querySelector('.flex.flex-wrap.gap-2.items-center'), `btn-${button.dataset.granularity}`);
                    updateUI();
                });
            });

            const dateRangeButtonsContainer = document.getElementById('date-range-buttons');
            const startDatePicker = document.getElementById('start-date-picker');
            const endDatePicker = document.getElementById('end-date-picker');

            dateRangeButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const days = button.dataset.days;
                let startDate, endDate;
                
                const isCustom = days === 'custom';
                startDatePicker.disabled = !isCustom;
                endDatePicker.disabled = !isCustom;

                if (days === 'all') {
                    startDate = new Date(datasetStartDate);
                    endDate = new Date(datasetEndDate);
                } else if (isCustom) {
                    updateActiveButton(dateRangeButtonsContainer, button.dataset.days);
                    return;
                } else {
                    const daysOffset = parseInt(days, 10);
                    endDate = new Date(datasetEndDate);
                    startDate = new Date(datasetEndDate);
                    startDate.setDate(datasetEndDate.getDate() - (daysOffset -1));
                }

                startDatePicker.value = startDate.toISOString().split('T')[0];
                endDatePicker.value = endDate.toISOString().split('T')[0];
                
                updateActiveButton(dateRangeButtonsContainer, button.dataset.days);
                updateUI();
            });

            startDatePicker.addEventListener('change', () => {
                updateActiveButton(dateRangeButtonsContainer, 'custom');
                updateUI();
            });
            endDatePicker.addEventListener('change', () => {
                updateActiveButton(dateRangeButtonsContainer, 'custom');
                updateUI();
            });

            document.getElementById('generate-insights-btn').addEventListener('click', generateInsights);
            
            document.getElementById('api-key-input').addEventListener('input', (event) => {
                localStorage.setItem('gemini-api-key', event.target.value);
            });

            window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', e => {
                updateUI();
            });

            const markedScript = document.createElement('script');
            markedScript.src = "https://cdn.jsdelivr.net/npm/marked/marked.min.js";
            document.head.appendChild(markedScript);
            markedScript.onload = () => {
                // Now marked is available
            };

            // Initialize the app
            fullDailyData = generateDailyData(datasetStartDate, datasetEndDate);
            
            const savedApiKey = localStorage.getItem('gemini-api-key');
            if (savedApiKey) {
                document.getElementById('api-key-input').value = savedApiKey;
            }

            // Set date range info text
            const infoEl = document.getElementById('date-range-info');
            infoEl.textContent = `データ期間: ${datasetStartDate.toLocaleDateString()} ~ ${datasetEndDate.toLocaleDateString()}`;

            // On first load, select the "All Time" button
            const allButton = document.querySelector('[data-days="all"]');
            allButton.click();
        });
    </script>
</body>
</html>
